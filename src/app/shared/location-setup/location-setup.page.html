<ion-content class="location-content" [scrollY]="false">

  <!-- Location Permission Overlay -->
  <div class="location-overlay" *ngIf="locationState !== 'ready'">

    <!-- Checking -->
    <div class="overlay-inner" *ngIf="locationState === 'checking'">
      <ion-spinner name="crescent" color="primary"></ion-spinner>
      <p class="overlay-text">Checking location...</p>
    </div>

    <!-- Permission Denied -->
    <div class="overlay-inner" *ngIf="locationState === 'denied'">
      <div class="overlay-icon denied">
        <ion-icon name="location-outline"></ion-icon>
      </div>
      <h3 class="overlay-title">Location Permission Required</h3>
      <p class="overlay-text">We need access to your location to show nearby restaurants and deliver to your address.</p>
      <ion-button class="overlay-btn" expand="block" (click)="retryLocationPermission()">
        Allow Location
      </ion-button>
    </div>

    <!-- GPS Disabled -->
    <div class="overlay-inner" *ngIf="locationState === 'disabled'">
      <div class="overlay-icon disabled">
        <ion-icon name="navigate-outline"></ion-icon>
      </div>
      <h3 class="overlay-title">Turn On Location</h3>
      <p class="overlay-text">Your device's GPS seems to be turned off. Please enable location services to continue.</p>
      <ion-button class="overlay-btn" expand="block" (click)="retryLocationPermission()">
        Retry
      </ion-button>
    </div>
  </div>

  <!-- Map -->
  <div class="map-container">
    <div class="map" #map></div>

    <!-- Center pin overlay (always centered on map) -->
    <div class="center-pin">
      <img src="assets/location_pin.png" alt="pin" />
    </div>
  </div>

  <!-- Search Bar Overlay -->
  <div class="search-overlay" *ngIf="locationState === 'ready'">
    <ion-button class="back-btn" fill="clear" (click)="goBack()">
      <ion-icon slot="icon-only" name="arrow-back-outline"></ion-icon>
    </ion-button>
    <div class="search-input-wrap" [class.active]="searchFocused">
      <ion-icon name="search-outline" class="search-icon"></ion-icon>
      <input
        #searchInput
        type="text"
        placeholder="Search location..."
        [(ngModel)]="searchQuery"
        (input)="onSearchInput()"
        (focus)="searchFocused = true"
        (blur)="onSearchBlur()"
        autocomplete="off"
      />
      <ion-icon
        *ngIf="searchQuery"
        name="close-circle"
        class="clear-icon"
        (mousedown)="clearSearch($event)"
      ></ion-icon>
    </div>
  </div>

  <!-- Autocomplete Results -->
  <div class="autocomplete-results" *ngIf="predictions.length > 0 && searchFocused">
    <div
      class="prediction-item"
      *ngFor="let prediction of predictions"
      (mousedown)="selectPrediction(prediction)"
    >
      <ion-icon name="location-outline" class="pred-icon"></ion-icon>
      <div class="pred-text">
        <span class="pred-main">{{ prediction.structured_formatting.main_text }}</span>
        <span class="pred-secondary">{{ prediction.structured_formatting.secondary_text }}</span>
      </div>
    </div>
  </div>

  <!-- Bottom Sheet -->
  <div class="bottom-sheet" [class.expanded]="sheetExpanded" *ngIf="locationState === 'ready'">
    <!-- Drag Handle -->
    <div class="drag-handle" (click)="sheetExpanded = !sheetExpanded">
      <div class="handle-bar"></div>
    </div>

    <!-- Current Address -->
    <div class="current-address">
      <div class="address-icon">
        <ion-icon name="location" color="danger"></ion-icon>
      </div>
      <div class="address-info">
        <span class="address-label">Current Location</span>
        <p class="address-text">{{ formattedAddress || 'Fetching address...' }}</p>
      </div>
    </div>

    <!-- Form -->
    <div class="address-form" *ngIf="sheetExpanded">
      <form [formGroup]="form">
        <!-- Locality -->
        <div class="form-field">
          <label class="field-label">Locality</label>
          <ion-select formControlName="locality" interface="popover" placeholder="Select locality">
            <ion-select-option *ngFor="let list of localities" [value]="list._id">
              {{ list.locality }}
            </ion-select-option>
          </ion-select>
        </div>

        <!-- Address Type -->
        <div class="form-field">
          <label class="field-label">Address Type</label>
          <div class="address-type-chips">
            <div
              class="type-chip"
              [class.selected]="form.get('addressType')?.value === 'home'"
              [class.disabled]="isTypeTaken('home')"
              (click)="selectAddressType('home')"
            >
              <ion-icon name="home-outline"></ion-icon>
              <span>Home</span>
            </div>
            <div
              class="type-chip"
              [class.selected]="form.get('addressType')?.value === 'officeWork'"
              [class.disabled]="isTypeTaken('officework')"
              (click)="selectAddressType('officeWork')"
            >
              <ion-icon name="briefcase-outline"></ion-icon>
              <span>Office</span>
            </div>
            <div
              class="type-chip"
              [class.selected]="form.get('addressType')?.value === 'others'"
              (click)="selectAddressType('others')"
            >
              <ion-icon name="navigate-outline"></ion-icon>
              <span>Other</span>
            </div>
          </div>
        </div>

        <!-- Landmark -->
        <div class="form-field">
          <label class="field-label">Landmark (Optional)</label>
          <div class="input-container">
            <ion-input formControlName="landmark" placeholder="Nearby landmark" [maxlength]="20"></ion-input>
          </div>
        </div>
      </form>
    </div>

    <!-- Save Button -->
    <ion-button class="save-btn" expand="block" (click)="saveAddress()">
      <span *ngIf="!sheetExpanded">Confirm Location</span>
      <span *ngIf="sheetExpanded && !editMode">Save Address</span>
      <span *ngIf="sheetExpanded && editMode">Update Address</span>
    </ion-button>
  </div>

</ion-content>
