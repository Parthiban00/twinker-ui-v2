<!-- Header -->
<ion-header class="ion-no-border">
  <ion-toolbar>
    <ion-buttons slot="start">
      <ion-button (click)="cancel()">
        <ion-icon slot="icon-only" name="arrow-back" color="dark"></ion-icon>
      </ion-button>
    </ion-buttons>
    <ion-title class="payment-title">Confirm Order</ion-title>
  </ion-toolbar>
</ion-header>

<ion-content [scrollY]="true" class="payment-content">

  <!-- Order Summary Card -->
  <div class="order-summary-card">
    <div class="summary-top">
      <div class="summary-icon-wrap">
        <ion-icon name="receipt-outline"></ion-icon>
      </div>
      <div class="summary-details">
        <span class="summary-label">Order Total</span>
        <span class="summary-amount">&#8377; {{ totalAmount.toFixed(2) }}</span>
      </div>
      <div class="summary-badge">
        <span class="badge-text">{{ totalItems }} {{ totalItems === 1 ? 'item' : 'items' }}</span>
      </div>
    </div>
    <div class="savings-strip" *ngIf="totalSaved > 0">
      <ion-icon name="pricetag-outline"></ion-icon>
      <span>You're saving &#8377; {{ totalSaved.toFixed(2) }} on this order</span>
    </div>
  </div>

  <!-- Fee Mini Summary -->
  <div class="fee-mini-summary" *ngIf="feeBreakdown">
    <div class="fee-mini-row" *ngIf="couponDiscount > 0">
      <span>Coupon discount</span>
      <span class="fee-mini-green">-&#8377;{{ couponDiscount.toFixed(2) }}</span>
    </div>
    <div class="fee-mini-row">
      <span>Delivery</span>
      <span *ngIf="!feeBreakdown.delivery.freeDeliveryApplied">&#8377;{{ deliveryFee.toFixed(2) }}</span>
      <span class="fee-mini-green" *ngIf="feeBreakdown.delivery.freeDeliveryApplied">FREE</span>
    </div>
    <div class="fee-mini-row" *ngIf="platformFee > 0">
      <span>Platform fee</span>
      <span>&#8377;{{ platformFee.toFixed(2) }}</span>
    </div>
    <div class="fee-mini-row" *ngIf="taxAmount > 0">
      <span>{{ feeBreakdown.tax.label }}</span>
      <span>&#8377;{{ taxAmount.toFixed(2) }}</span>
    </div>
  </div>

  <!-- Delivery Address -->
  <div class="section">
    <div class="section-label">
      <ion-icon name="location-outline" class="section-icon"></ion-icon>
      <span>Delivering to</span>
    </div>
    <div class="address-card">
      <div class="address-left">
        <span class="address-tag">
          <ion-icon name="business-outline"></ion-icon>
          Office
        </span>
        <p class="address-text">{{ deliveryAddress || 'Default delivery address' }}</p>
      </div>
      <button class="change-link">Change</button>
    </div>
  </div>

  <!-- Payment Method -->
  <div class="section">
    <div class="section-label">
      <ion-icon name="wallet-outline" class="section-icon"></ion-icon>
      <span>Payment method</span>
    </div>

    <div class="payment-options">
      <button
        *ngFor="let option of paymentOptions"
        class="payment-option"
        [class.selected]="selectedPayment === option.id"
        [class.disabled]="!option.enabled"
        (click)="selectPayment(option.id)">

        <div class="option-radio">
          <div class="radio-outer">
            <div class="radio-inner" *ngIf="selectedPayment === option.id"></div>
          </div>
        </div>

        <div class="option-icon-wrap" [class.disabled-icon]="!option.enabled">
          <ion-icon [name]="option.icon"></ion-icon>
        </div>

        <div class="option-text">
          <span class="option-name">{{ option.name }}</span>
          <span class="option-desc">{{ option.description }}</span>
        </div>

        <span class="soon-tag" *ngIf="!option.enabled">Soon</span>
      </button>
    </div>
  </div>

  <!-- Exact Change Note -->
  <div class="info-note" *ngIf="selectedPayment === 'COD'">
    <ion-icon name="information-circle-outline"></ion-icon>
    <span>Please keep exact change ready for the delivery partner</span>
  </div>


</ion-content>

<!-- Footer -->
<ion-footer class="ion-no-border">
  <div class="confirm-footer">
    <div class="footer-top">
      <span class="footer-total-label">Total</span>
      <span class="footer-total-amount">&#8377; {{ totalAmount.toFixed(2) }}</span>
    </div>
    <button
      class="confirm-btn"
      [class.placing]="isPlacing"
      [disabled]="isPlacing"
      (click)="confirmOrder()">
      <span *ngIf="!isPlacing">Confirm & Place Order</span>
      <span *ngIf="isPlacing" class="placing-text">
        <ion-spinner name="crescent" class="btn-spinner"></ion-spinner>
        Placing order...
      </span>
    </button>
  </div>
</ion-footer>

<!-- ─── Order Error Dialog ─── -->
<div class="err-backdrop" *ngIf="showErrorDialog" (click)="errorType !== 'vendor_closed' && closeErrorDialog()">
  <div class="err-sheet" [class]="'err-sheet--' + errorType" (click)="$event.stopPropagation()">

    <!-- Handle bar -->
    <div class="err-handle"></div>

    <!-- Icon -->
    <div class="err-icon-ring" [class]="'err-icon-ring--' + errorType">
      <div class="err-icon-circle" [class]="'err-icon-circle--' + errorType">
        <ion-icon [name]="errorIcon"></ion-icon>
      </div>
    </div>

    <!-- Text -->
    <h2 class="err-title">{{ errorTitle }}</h2>
    <p class="err-message">{{ errorMessage }}</p>

    <!-- Vendor chips (VENDOR_UNAVAILABLE only) -->
    <div class="err-vendor-chips" *ngIf="errorType === 'vendor_closed' && errorClosedVendors.length">
      <span class="err-vendor-chip" *ngFor="let v of errorClosedVendors">
        <ion-icon name="storefront-outline"></ion-icon>
        {{ v }}
      </span>
    </div>

    <!-- Helper note for vendor_closed -->
    <div class="err-helper-note" *ngIf="errorType === 'vendor_closed'">
      <ion-icon name="time-outline"></ion-icon>
      <span>Remove the closed store from your cart or try again when it reopens.</span>
    </div>

    <!-- Actions -->
    <div class="err-actions">

      <!-- vendor_closed -->
      <ng-container *ngIf="errorType === 'vendor_closed'">
        <button class="err-btn err-btn--primary" (click)="dismissToCart()">
          <ion-icon name="cart-outline"></ion-icon>
          Back to Cart
        </button>
      </ng-container>

      <!-- active_order -->
      <ng-container *ngIf="errorType === 'active_order'">
        <button class="err-btn err-btn--primary" (click)="placeOrderForced()">
          <ion-icon name="checkmark-circle-outline"></ion-icon>
          Place Anyway
        </button>
        <button class="err-btn err-btn--ghost" (click)="closeErrorDialog()">
          Cancel
        </button>
      </ng-container>

      <!-- generic -->
      <ng-container *ngIf="errorType === 'generic'">
        <button class="err-btn err-btn--primary" (click)="closeErrorDialog()">
          <ion-icon name="refresh-outline"></ion-icon>
          Try Again
        </button>
        <button class="err-btn err-btn--ghost" (click)="dismissToCart()">
          Go Back
        </button>
      </ng-container>

    </div>
  </div>
</div>
