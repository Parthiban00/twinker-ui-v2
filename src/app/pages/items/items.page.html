<ion-header class="ion-no-border" [class.sticky-active]="stickyHeader">
  <ion-toolbar>
    <ion-buttons slot="start">
      <ion-button (click)="goBack()">
        <ion-icon slot="icon-only" name="arrow-back" [color]="stickyHeader ? 'dark' : 'light'"></ion-icon>
      </ion-button>
    </ion-buttons>
    <ion-title *ngIf="stickyHeader" class="sticky-title">{{ displayVendor.name }}</ion-title>
    <ion-buttons slot="end">
      <ion-button>
        <ion-icon slot="icon-only" name="share-social-outline" [color]="stickyHeader ? 'dark' : 'light'"></ion-icon>
      </ion-button>
    </ion-buttons>
  </ion-toolbar>

  <!-- Sticky Search + Tabs (slides down when scrolled past menu area) -->
  <div class="sticky-bar" [class.visible]="stickyHeader">
    <div class="sticky-search">
      <ion-searchbar [value]="searchTerm" [debounce]="300" (ionInput)="handleSearchInput($event)"
        placeholder="Search for dishes..." class="sticky-searchbar"></ion-searchbar>
    </div>
    <div class="sticky-tabs">
      <div class="tabs-scroll">
        <button *ngFor="let tab of categoryTabs"
                class="tab-btn"
                [class.active]="selectedCategory === tab.id"
                (click)="selectCategory(tab.id)">
          {{ tab.name }}
        </button>
      </div>
    </div>
  </div>
</ion-header>

<ion-content [fullscreen]="true" [scrollEvents]="true" (ionScroll)="onScroll($event)">

  <!-- Cover Image -->
  <div class="cover-image">
    <img [src]="getCoverImage()" alt="Restaurant cover" />
  </div>

  <!-- Restaurant Info Card -->
  <div class="info-card">

    <!-- Favorite Button -->
    <div class="fav-btn-wrap">
      <button class="fav-btn">
        <ion-icon name="heart-outline" color="danger"></ion-icon>
      </button>
    </div>

    <!-- Restaurant Name -->
    <h1 class="restaurant-name">{{ displayVendor.name }}</h1>
    <p class="restaurant-address">{{ displayVendor.address || displayVendor.slogan }}</p>

    <!-- Info Badges -->
    <div class="info-badges">
      <div class="badge">
        <ion-icon name="star" class="badge-icon star"></ion-icon>
        <span>{{ displayVendor.rating || 4.6 }}</span>
      </div>
      <div class="badge">
        <ion-icon name="bicycle-outline" class="badge-icon"></ion-icon>
        <span>{{ displayVendor.distance || '4.2km' }}</span>
      </div>
      <div class="badge">
        <ion-icon name="time-outline" class="badge-icon"></ion-icon>
        <span>{{ displayVendor.deliveryTime || '30 min' }}</span>
      </div>
    </div>

    <!-- Tag Pills -->
    <div class="tag-pills">
      <span class="tag-pill" *ngFor="let tag of (displayVendor.tags || ['Free delivery', 'Take away'])">
        {{ tag }}
      </span>
    </div>

    <!-- Discount Section -->
    <div class="discount-section" *ngIf="displayDiscounts.length">
      <p class="discount-label">Discount for you</p>
      <div class="discount-badges">
        <div class="discount-badge" *ngFor="let discount of displayDiscounts">
          <ion-icon [name]="discount.icon" [style.color]="discount.color"></ion-icon>
          <span>{{ discount.label }}</span>
        </div>
      </div>
    </div>

    <!-- Inline Search Bar (anchor for sticky detection) -->
    <div class="search-bar-inline" #menuAnchor>
      <div class="search-input-wrap">
        <ion-icon name="search-outline" class="search-icon"></ion-icon>
        <input type="text" class="search-input" placeholder="Search for dishes..."
               [value]="searchTerm" (input)="onInlineSearch($event)" />
        <ion-icon name="close-circle" class="clear-icon" *ngIf="searchTerm" (click)="clearSearch()"></ion-icon>
      </div>
    </div>

    <!-- Category Tabs -->
    <div class="category-tabs">
      <div class="tabs-scroll">
        <button *ngFor="let tab of categoryTabs"
                class="tab-btn"
                [class.active]="selectedCategory === tab.id"
                (click)="selectCategory(tab.id)">
          {{ tab.name }}
        </button>
      </div>
    </div>

    <!-- Most Popular Section -->
    <div class="popular-section" id="section-popular" *ngIf="filteredPopularItems.length">
      <h3 class="section-title">Most popular</h3>
      <div class="popular-grid">
        <div class="popular-card" *ngFor="let item of filteredPopularItems">
          <div class="popular-img-wrap">
            <img [src]="getItemImage(item)" [alt]="item.productName" />

            <!-- Customizable: always show Add button -->
            <ng-container *ngIf="isCustomizable(item)">
              <div class="add-btn-wrap">
                <button class="add-btn" (click)="addItem(item)">Add</button>
                <span class="customise-badge" *ngIf="getDisplayCount(item)">{{ getDisplayCount(item) }}</span>
              </div>
            </ng-container>

            <!-- Non-customizable: standard +/- -->
            <ng-container *ngIf="!isCustomizable(item)">
              <button class="add-btn" *ngIf="!item.itemCount" (click)="addItem(item)">Add</button>
              <div class="qty-control" *ngIf="item.itemCount">
                <button class="qty-btn" (click)="removeItem(item)">-</button>
                <span class="qty-count">{{ item.itemCount }}</span>
                <button class="qty-btn" (click)="addItem(item)">+</button>
              </div>
            </ng-container>
          </div>
          <p class="popular-name">{{ item.productName }}</p>
          <p class="popular-desc">{{ item.description }}</p>
          <p class="popular-price">$ {{ item.price }}</p>
          <span class="customisable-tag" *ngIf="isCustomizable(item)">Customisable</span>
        </div>
      </div>
    </div>

    <!-- Category Sections -->
    <ng-container *ngFor="let section of displayProducts">
      <div class="category-section" [id]="'section-' + section.category._id"
           *ngIf="section.category._id !== 'popular' && getFilteredProducts(section.products).length">

        <h3 class="section-title">{{ section.category.categoryName }}</h3>

        <div class="item-card" *ngFor="let product of getFilteredProducts(section.products)">
          <div class="item-info">
            <div class="item-type-row">
              <img *ngIf="product.type==='non-veg'" src="assets/non-veg.png" class="type-icon" />
              <img *ngIf="product.type==='veg'" src="assets/veg.png" class="type-icon" />
              <img *ngIf="product.type==='egg'" src="assets/egg.png" class="type-icon" />
              <span class="item-tag" *ngIf="product.tag && product.tag !== 'none'">{{ product.tag | uppercase }}</span>
            </div>
            <h4 class="item-name">{{ product.productName }}</h4>
            <p class="item-desc">{{ product.description }}</p>
            <p class="item-price">$ {{ product.price }}</p>
            <span class="customisable-tag" *ngIf="isCustomizable(product)">Customisable</span>
          </div>

          <div class="item-img-wrap">
            <img [src]="getItemImage(product)" [alt]="product.productName" class="item-img" />

            <!-- Customizable: always show Add button with badge -->
            <ng-container *ngIf="isCustomizable(product)">
              <div class="add-btn-wrap">
                <button class="add-btn" (click)="addItem(product)">Add</button>
                <span class="customise-badge" *ngIf="getDisplayCount(product)">{{ getDisplayCount(product) }}</span>
              </div>
            </ng-container>

            <!-- Non-customizable: standard +/- -->
            <ng-container *ngIf="!isCustomizable(product)">
              <button class="add-btn" *ngIf="!product.itemCount" (click)="addItem(product)">Add</button>
              <div class="qty-control" *ngIf="product.itemCount">
                <button class="qty-btn" (click)="removeItem(product)">-</button>
                <span class="qty-count">{{ product.itemCount }}</span>
                <button class="qty-btn" (click)="addItem(product)">+</button>
              </div>
            </ng-container>
          </div>
        </div>

      </div>
    </ng-container>

    <!-- No results -->
    <div class="no-results" *ngIf="searchTerm && !hasSearchResults()">
      <ion-icon name="search-outline"></ion-icon>
      <p>No dishes found for "{{ searchTerm }}"</p>
    </div>

  </div>

</ion-content>

<!-- Backdrop -->
<div class="menu-backdrop" [class.visible]="showMenuSheet" (click)="toggleMenuSheet()"></div>

<!-- Bottom Sheet -->
<div class="menu-sheet" [class.open]="showMenuSheet">
  <div class="sheet-handle" (click)="toggleMenuSheet()"></div>
  <h3 class="sheet-title">Menu</h3>
  <div class="sheet-list">
    <button *ngFor="let section of displayProducts"
            class="sheet-item"
            [class.active]="selectedCategory === section.category._id"
            (click)="navigateToCategory(section.category._id)">
      <span class="sheet-item-name">{{ section.category.categoryName }}</span>
      <span class="sheet-item-count">{{ section.products.length }}</span>
    </button>
  </div>
</div>

<!-- Cart Bar -->
<div class="cart-bar" *ngIf="cartItems.length" [class.shifted]="showMenuSheet">
  <div class="cart-bar-info">
    <span class="cart-bar-count">{{ cartTotalItems }} {{ cartTotalItems === 1 ? 'Item' : 'Items' }}</span>
    <span class="cart-bar-name">{{ cartFirstItemName }}{{ cartItems.length > 1 ? ' & more' : '' }}</span>
  </div>
  <div class="cart-bar-action">
    <span class="cart-bar-price">$ {{ cartTotalPrice.toFixed(2) }}</span>
    <ion-icon name="chevron-forward-outline"></ion-icon>
  </div>
</div>

<!-- Floating Menu Button -->
<button class="floating-menu-btn" [class.hidden]="showMenuSheet" [class.above-cart]="cartItems.length" (click)="toggleMenuSheet()">
  <ion-icon name="restaurant-outline"></ion-icon>
  <span>Menu</span>
</button>
