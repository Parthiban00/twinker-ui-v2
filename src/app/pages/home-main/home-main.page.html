<ion-header class="ion-no-border">
  <ion-toolbar>
    <!-- Greeting -->
    <div class="greeting-row" *ngIf="greeting">
      <span class="greeting-text">{{ greeting }}<span *ngIf="userName">, {{ userName }}</span>!</span>
    </div>
    <div class="header-top">
      <div class="address-section" [routerLink]="['/location-setup']">
        <span class="address-label">Your current address</span>
        <div class="address-value" *ngIf="defaultAddress">
          <span class="elipsis">{{ defaultAddress.fullAddress }}</span>
          <ion-icon name="chevron-down"></ion-icon>
        </div>
      </div>
      <div class="header-icons">
        <ion-icon name="heart-outline"></ion-icon>
        <ion-icon name="notifications-outline"></ion-icon>
      </div>
    </div>
    <div class="search-container" (click)="navigateToSearch()">
      <div class="search-bar">
        <ion-icon name="search-outline"></ion-icon>
        <span>Search food, groceries, medicines...</span>
      </div>
    </div>
  </ion-toolbar>
</ion-header>

<ion-content>

  <!-- Loading Skeletons -->
  <div *ngIf="isLoading" class="skeleton-wrapper">
    <!-- Categories skeleton -->
    <div class="service-pillars-section">
      <div class="service-pillars-scroll">
        <div class="service-pillar" *ngFor="let i of [1,2,3,4,5]">
          <ion-skeleton-text [animated]="true" style="width: 64px; height: 64px; border-radius: 18px;"></ion-skeleton-text>
          <ion-skeleton-text [animated]="true" style="width: 50px; height: 12px; border-radius: 6px;"></ion-skeleton-text>
        </div>
      </div>
    </div>
    <!-- Banner skeleton -->
    <div style="padding: 16px;">
      <ion-skeleton-text [animated]="true" style="width: 100%; height: 160px; border-radius: 16px;"></ion-skeleton-text>
    </div>
    <!-- Popular items skeleton -->
    <div style="padding: 16px;">
      <ion-skeleton-text [animated]="true" style="width: 180px; height: 22px; border-radius: 6px; margin-bottom: 14px;"></ion-skeleton-text>
      <div style="display: flex; gap: 12px; overflow: hidden;">
        <div *ngFor="let i of [1,2,3]" style="min-width: 148px;">
          <ion-skeleton-text [animated]="true" style="width: 148px; height: 100px; border-radius: 14px 14px 0 0;"></ion-skeleton-text>
          <ion-skeleton-text [animated]="true" style="width: 120px; height: 14px; border-radius: 6px; margin-top: 10px;"></ion-skeleton-text>
          <ion-skeleton-text [animated]="true" style="width: 80px; height: 12px; border-radius: 6px; margin-top: 4px;"></ion-skeleton-text>
        </div>
      </div>
    </div>
    <!-- Cuisine grid skeleton -->
    <div style="padding: 16px;">
      <ion-skeleton-text [animated]="true" style="width: 180px; height: 22px; border-radius: 6px; margin-bottom: 14px;"></ion-skeleton-text>
      <div style="display: grid; grid-template-columns: repeat(4, 1fr); gap: 16px 12px;">
        <div *ngFor="let i of [1,2,3,4,5,6,7,8]" style="display: flex; flex-direction: column; align-items: center; gap: 8px;">
          <ion-skeleton-text [animated]="true" style="width: 60px; height: 60px; border-radius: 50%;"></ion-skeleton-text>
          <ion-skeleton-text [animated]="true" style="width: 44px; height: 12px; border-radius: 6px;"></ion-skeleton-text>
        </div>
      </div>
    </div>
  </div>

  <!-- Loaded Content -->
  <div *ngIf="!isLoading">

    <!-- Section 1: Service Pillars / Categories -->
    <div class="service-pillars-section anim-section" *ngIf="categories.length" style="animation-delay: 0s;">
      <div class="service-pillars-scroll">
        <div class="service-pillar pulse-once" *ngFor="let cat of categories; let i = index"
          [style.animation-delay]="(i * 0.05) + 's'"
          (click)="navigateService(cat)">
          <div class="pillar-icon-wrap" [ngStyle]="{'background-color': '#FFF0F0'}">
            <img *ngIf="cat.imageUrl" [src]="imgBaseUrl + cat.imageUrl" class="pillar-img" alt="{{ cat.categoryName }}" />
            <ion-icon *ngIf="!cat.imageUrl" name="storefront-outline" style="color: #F85C70;"></ion-icon>
          </div>
          <span class="pillar-name">{{ cat.categoryName }}</span>
          <span class="pillar-time" *ngIf="cat.vendorDetails?.length" style="color: #F85C70;">{{ cat.vendorDetails.length }} stores</span>
        </div>
      </div>
    </div>

    <!-- Section 2: Offers & Deals Swiper -->
    <div class="banner-carousel anim-section" *ngIf="deals.length" style="animation-delay: 0.1s;">
      <swiper-container slides-per-view="1.3" space-between="12" pagination="true" autoplay-delay="3000" loop="true">
        <swiper-slide *ngFor="let deal of deals">
          <div class="deal-card" (click)="navigateRestaurant(deal.vendor)">
            <div class="deal-img-wrap">
              <img *ngIf="deal.imageUrl" [src]="imgBaseUrl + deal.imageUrl" alt="{{ deal.productName }}" />
              <div class="deal-img-placeholder" *ngIf="!deal.imageUrl">
                <ion-icon name="pricetag-outline"></ion-icon>
              </div>
            </div>
            <div class="deal-overlay">
              <div class="deal-discount-badge" *ngIf="deal.discount">{{ getDiscountLabel(deal) }}</div>
              <div class="deal-text">
                <h3>{{ deal.productName }}</h3>
                <p *ngIf="deal.vendor">{{ deal.vendor.name }}</p>
                <div class="deal-price-row">
                  <span class="deal-price">&#8377;{{ deal.price }}</span>
                  <span class="deal-actual-price" *ngIf="deal.actualPrice > deal.price">&#8377;{{ deal.actualPrice }}</span>
                </div>
              </div>
              <span class="deal-cta">Tap to order</span>
            </div>
            <div class="deal-category-tag" *ngIf="deal.category">{{ deal.category.categoryName }}</div>
          </div>
        </swiper-slide>
      </swiper-container>
    </div>

    <!-- Section 2.5: Flash Deals (time-sensitive offers) -->
    <div class="flash-deals-section anim-section" *ngIf="flashDeals.length" style="animation-delay: 0.15s;">
      <div class="section-header">
        <h2>
          <ion-icon name="flash" class="flash-icon"></ion-icon>
          Flash Deals
        </h2>
      </div>
      <div class="flash-deals-scroll">
        <div class="flash-deal-card" *ngFor="let deal of flashDeals" (click)="navigateFlashDeal(deal)">
          <div class="flash-timer-chip">
            <ion-icon name="time-outline"></ion-icon>
            {{ deal.timeLeft }}
          </div>
          <div class="flash-deal-content">
            <div class="flash-discount">{{ deal.discountType === 'percentage' ? deal.discountValue + '% OFF' : '&#8377;' + deal.discountValue + ' OFF' }}</div>
            <h4 class="flash-title">{{ deal.title }}</h4>
            <p class="flash-desc">{{ deal.description }}</p>
            <span class="flash-code" *ngIf="deal.code">{{ deal.code }}</span>
          </div>
          <div class="flash-cta">Grab now</div>
        </div>
      </div>
    </div>

    <!-- Section 3: Wallet & Coins (hidden for now) -->
    <div class="wallet-section" *ngIf="showWallet">
      <div class="wallet-item">
        <div class="wallet-icon wallet-bg">
          <ion-icon name="wallet-outline"></ion-icon>
        </div>
        <div class="wallet-info">
          <div class="wallet-title">Your Wallet</div>
          <div class="wallet-value">Rp699.000</div>
        </div>
      </div>
      <div class="wallet-divider"></div>
      <div class="wallet-item">
        <div class="wallet-icon coins-bg">
          <ion-icon name="disc-outline"></ion-icon>
        </div>
        <div class="wallet-info">
          <div class="wallet-title">Your Coins</div>
          <div class="wallet-value">1.200</div>
        </div>
      </div>
    </div>

    <!-- Section 4: Popular in your area -->
    <div class="order-again-section anim-section" *ngIf="popularItems.length" style="animation-delay: 0.2s;">
      <div class="section-header">
        <h2>Popular in your area</h2>
        <span class="see-all" (click)="navigateToPopularItems()">See all</span>
      </div>
      <div class="order-again-scroll">
        <div class="order-again-card" *ngFor="let item of popularItems" (click)="navigatePopularItem(item)">
          <div class="order-again-img">
            <img *ngIf="item.imageUrl" [src]="imgBaseUrl + item.imageUrl" alt="{{ item.productName }}" />
            <div class="img-placeholder" *ngIf="!item.imageUrl">
              <ion-icon name="restaurant-outline"></ion-icon>
            </div>
            <div class="item-tag" *ngIf="item.tag && item.tag !== 'none'">{{ item.tag }}</div>
          </div>
          <div class="order-again-info">
            <span class="order-item-name">{{ item.productName }}</span>
            <span class="order-item-vendor" *ngIf="item.vendor">{{ item.vendor.name }}</span>
            <div class="order-item-bottom">
              <span class="order-item-price">&#8377;{{ item.price }}</span>
              <button class="add-btn" (click)="addToCart(item); $event.stopPropagation()">
                <ion-icon name="add-outline"></ion-icon>
              </button>
            </div>
          </div>
        </div>
      </div>
    </div>

    <!-- Section 4.5: Offers For You (coupon banner) -->
    <div class="coupon-banner anim-section" *ngIf="bestCoupon" style="animation-delay: 0.25s;">
      <div class="coupon-inner">
        <div class="coupon-left">
          <ion-icon name="pricetag" class="coupon-icon"></ion-icon>
        </div>
        <div class="coupon-center">
          <span class="coupon-label">Best offer for you</span>
          <span class="coupon-value">{{ bestCoupon.discountType === 'percentage' ? bestCoupon.discountValue + '% OFF' : '&#8377;' + bestCoupon.discountValue + ' OFF' }}</span>
          <span class="coupon-desc">{{ bestCoupon.title }}</span>
        </div>
        <div class="coupon-right">
          <div class="coupon-code-box">
            <span class="coupon-code">{{ bestCoupon.code }}</span>
            <button class="copy-btn" (click)="copyCode(bestCoupon.code)">
              {{ couponCopied ? 'Copied!' : 'COPY' }}
            </button>
          </div>
        </div>
      </div>
    </div>

    <!-- Section 5: What's on your mind? -->
    <div class="cuisine-section anim-section" *ngIf="cuisines.length" style="animation-delay: 0.3s;">
      <div class="section-header">
        <h2>What's on your mind?</h2>
      </div>
      <div class="cuisine-grid">
        <div class="cuisine-item" *ngFor="let cuisine of cuisines" (click)="navigateCuisine(cuisine)">
          <div class="cuisine-circle" [ngStyle]="{'background-color': cuisine.bgColor}">
            <img *ngIf="cuisine.imageUrl" [src]="imgBaseUrl + cuisine.imageUrl" class="cuisine-img" alt="{{ cuisine.name }}" />
            <ion-icon *ngIf="!cuisine.imageUrl && cuisine.icon" [name]="cuisine.icon" [ngStyle]="{'color': cuisine.accentColor}"></ion-icon>
            <ion-icon *ngIf="!cuisine.imageUrl && !cuisine.icon" name="restaurant-outline" [ngStyle]="{'color': cuisine.accentColor}"></ion-icon>
          </div>
          <span class="cuisine-label">{{ cuisine.name }}</span>
        </div>
      </div>
    </div>

    <!-- Section 6: Popular Restaurants Near You (Enhanced) -->
    <div class="popular-restaurants-section anim-section" *ngIf="popularVendors.length" style="animation-delay: 0.35s;">
      <div class="section-header">
        <h2>Popular near you</h2>
        <span class="see-all" (click)="navigateToPopularVendors()">See all</span>
      </div>
      <div class="popular-scroll">
        <div class="restaurant-card" *ngFor="let vendor of popularVendors" (click)="navigateRestaurant(vendor)">
          <div class="restaurant-cover">
            <img *ngIf="vendor.profileImgUrl" [src]="imgBaseUrl + vendor.profileImgUrl" alt="{{ vendor.name }}" />
            <div class="img-placeholder" *ngIf="!vendor.profileImgUrl">
              <ion-icon name="storefront-outline"></ion-icon>
            </div>
            <!-- Rating badge -->
            <div class="vendor-rating-badge">
              <ion-icon name="star"></ion-icon>
              <span>{{ vendor.rating || '4.5' }}</span>
            </div>
            <!-- Delivery time pill -->
            <div class="vendor-delivery-pill" *ngIf="vendor.approxDeliveryTime">
              <ion-icon name="time-outline"></ion-icon>
              <span>~{{ vendor.approxDeliveryTime }} min</span>
            </div>
          </div>
          <div class="restaurant-info">
            <div class="restaurant-name-row">
              <span class="restaurant-name">{{ vendor.name }}</span>
            </div>
            <span class="restaurant-meta" *ngIf="vendor.address">{{ vendor.address }}</span>
            <div class="restaurant-categories" *ngIf="vendor.categories?.length">
              <span class="category-chip" *ngFor="let cat of vendor.categories.slice(0, 3)">{{ cat.categoryName }}</span>
            </div>
          </div>
        </div>
      </div>
    </div>

    <!-- Section 6.5: Top Rated Near You -->
    <div class="popular-restaurants-section anim-section" *ngIf="topRatedVendors.length" style="animation-delay: 0.4s;">
      <div class="section-header">
        <h2>Top rated near you</h2>
      </div>
      <div class="popular-scroll">
        <div class="restaurant-card top-rated-card" *ngFor="let vendor of topRatedVendors" (click)="navigateRestaurant(vendor)">
          <div class="restaurant-cover">
            <img *ngIf="vendor.profileImgUrl" [src]="imgBaseUrl + vendor.profileImgUrl" alt="{{ vendor.name }}" />
            <div class="img-placeholder" *ngIf="!vendor.profileImgUrl">
              <ion-icon name="storefront-outline"></ion-icon>
            </div>
            <!-- Prominent rating badge -->
            <div class="top-rating-badge">
              <ion-icon name="star"></ion-icon>
              <span>{{ vendor.rating || '4.5' }}</span>
            </div>
          </div>
          <div class="restaurant-info">
            <div class="restaurant-name-row">
              <span class="restaurant-name">{{ vendor.name }}</span>
            </div>
            <span class="restaurant-meta" *ngIf="vendor.address">{{ vendor.address }}</span>
            <div class="restaurant-categories" *ngIf="vendor.categories?.length">
              <span class="category-chip" *ngFor="let cat of vendor.categories.slice(0, 3)">{{ cat.categoryName }}</span>
            </div>
            <span class="vendor-distance-meta" *ngIf="vendor.distance">{{ vendor.distance }} km away</span>
          </div>
        </div>
      </div>
    </div>

    <!-- Section 7: Essentials at your doorstep -->
    <div class="essentials-section anim-section" style="animation-delay: 0.45s;">
      <div class="section-header">
        <h2>Essentials at your doorstep</h2>
      </div>
      <div class="essentials-grid">
        <div class="essential-card essential-groceries" (click)="navigateEssential('groceries')">
          <div class="essential-content">
            <div class="essential-icon-wrap">
              <ion-icon name="cart-outline"></ion-icon>
            </div>
            <h3>Groceries</h3>
            <p>Fresh fruits, veggies & daily essentials</p>
            <button class="essential-btn">Shop now</button>
          </div>
        </div>
        <div class="essential-card essential-medicine" (click)="navigateEssential('medicine')">
          <div class="essential-content">
            <div class="essential-icon-wrap">
              <ion-icon name="medkit-outline"></ion-icon>
            </div>
            <h3>Medicines</h3>
            <p>Get it in 20 mins. Upload prescription</p>
            <button class="essential-btn">Order now</button>
          </div>
        </div>
      </div>
    </div>

    <!-- Section 8: Buddy Services (hidden for now) -->
    <div class="buddy-section" *ngIf="showBuddy">
      <div class="section-header">
        <h2>MoMo Buddy Services</h2>
      </div>
      <div class="buddy-cards">
        <div class="buddy-card">
          <div class="buddy-card-icon">
            <img src="assets/send-items.png" />
          </div>
          <div class="buddy-card-info">
            <span class="buddy-card-title">Send/Receive Items</span>
            <span class="buddy-card-desc">Quick delivery to anyone</span>
          </div>
          <ion-icon name="chevron-forward-outline" class="buddy-card-arrow"></ion-icon>
        </div>
        <div class="buddy-card">
          <div class="buddy-card-icon">
            <img src="assets/your-needs.png" />
          </div>
          <div class="buddy-card-info">
            <span class="buddy-card-title">Your needs</span>
            <span class="buddy-card-desc">Tell us what you need</span>
          </div>
          <ion-icon name="chevron-forward-outline" class="buddy-card-arrow"></ion-icon>
        </div>
        <div class="buddy-card">
          <div class="buddy-card-icon">
            <img src="assets/buddy.png" />
          </div>
          <div class="buddy-card-info">
            <span class="buddy-card-title">Buddy for you</span>
            <span class="buddy-card-desc">Personal assistant service</span>
          </div>
          <ion-icon name="chevron-forward-outline" class="buddy-card-arrow"></ion-icon>
        </div>
      </div>
    </div>

  </div><!-- end !isLoading -->

  <!-- Bottom Spacer (extra space for cart bar) -->
  <div [style.height.px]="cartItems.length ? 90 : 20"></div>

</ion-content>

<!-- View Cart Bar -->
<div class="cart-bar" *ngIf="cartItems.length" (click)="navigateToCart()">
  <div class="cart-bar-left">
    <ion-icon name="cart"></ion-icon>
    <span class="cart-bar-count">{{ cartItemCount }} item{{ cartItemCount > 1 ? 's' : '' }}</span>
    <span class="cart-bar-separator">|</span>
    <span class="cart-bar-total">&#8377;{{ cartTotal.toFixed(2) }}</span>
  </div>
  <div class="cart-bar-right">
    <span>View Cart</span>
    <ion-icon name="arrow-forward"></ion-icon>
  </div>
</div>
