<!-- Header -->
<ion-header class="ion-no-border">
  <ion-toolbar>
    <ion-buttons slot="start">
      <ion-button (click)="goBack()">
        <ion-icon slot="icon-only" name="arrow-back" color="dark"></ion-icon>
      </ion-button>
    </ion-buttons>
    <ion-title class="cart-title">My Cart</ion-title>
    <ion-buttons slot="end">
      <ion-button>
        <ion-icon slot="icon-only" name="heart-outline" color="danger"></ion-icon>
      </ion-button>
    </ion-buttons>
  </ion-toolbar>
</ion-header>

<ion-content [fullscreen]="true">

  <!-- Empty State -->
  <div class="empty-state" *ngIf="isCartEmpty">
    <ion-icon name="cart-outline" class="empty-icon"></ion-icon>
    <h2 class="empty-title">Your cart is empty</h2>
    <p class="empty-subtitle">Add items from a restaurant to start your order</p>
    <button class="browse-btn" (click)="browsRestaurants()">Browse Restaurants</button>
  </div>

  <div class="cart-content" *ngIf="!isCartEmpty">

    <!-- Delivery Location -->
    <div class="section-block">
      <h3 class="section-heading">Delivery location</h3>
      <div class="delivery-card">
        <div class="delivery-info">
          <p class="delivery-distance" *ngIf="feeBreakdown">
            <strong>{{ feeBreakdown.delivery.maxDistanceKm }} km distance</strong>
          </p>
          <p class="delivery-distance" *ngIf="!feeBreakdown && !isLoadingFees">
            <strong>Calculating...</strong>
          </p>
          <p class="delivery-meta" *ngIf="feeBreakdown">
            Est. delivery fee &#8377;{{ feeBreakdown.delivery.originalFee.toFixed(0) }}
            <span *ngIf="feeBreakdown.delivery.freeDeliveryApplied"> &middot; Free delivery!</span>
          </p>
        </div>
        <button class="link-btn" (click)="changeLocation()">Change location</button>
      </div>
      <div class="action-chips">
        <button class="chip-btn">Add note</button>
      </div>
      <div class="address-box" *ngIf="userAddress">
        <p>{{ userAddress.fullAddress || userAddress.addressLine1 || 'Delivery address' }}</p>
      </div>
    </div>

    <div class="divider"></div>

    <!-- Vendor Groups -->
    <div class="vendor-group" *ngFor="let group of vendorGroups">
      <!-- Vendor Header -->
      <div class="vendor-header" (click)="goToVendor(group.vendorId)">
        <div class="vendor-avatar">
          <img [src]="getVendorImage(group)" [alt]="group.vendorName" />
        </div>
        <div class="vendor-info">
          <h4 class="vendor-name">{{ group.vendorName }}</h4>
          <p class="vendor-cuisine" *ngIf="group.vendorCuisine">{{ group.vendorCuisine }}</p>
        </div>
        <ion-icon name="chevron-forward-outline" class="vendor-arrow"></ion-icon>
      </div>

      <!-- Cart Items -->
      <div class="cart-item" *ngFor="let item of group.items">
        <div class="cart-item-left">
          <div class="item-type-row">
            <img *ngIf="item.type === 'non-veg'" src="assets/non-veg.png" class="type-icon" />
            <img *ngIf="item.type === 'veg'" src="assets/veg.png" class="type-icon" />
            <img *ngIf="item.type === 'egg'" src="assets/egg.png" class="type-icon" />
          </div>
          <h4 class="cart-item-name">{{ item.productName }}</h4>
          <p class="cart-item-customization" *ngIf="item.customizationSummary">{{ item.customizationSummary }}</p>
          <div class="cart-item-price-row">
            <span class="cart-item-price">&#8377; {{ (item.price * item.itemCount).toFixed(2) }}</span>
            <span class="cart-item-original" *ngIf="item.basePrice && item.basePrice !== item.price">
              &#8377; {{ (item.basePrice * item.itemCount).toFixed(2) }}
            </span>
          </div>
          <div class="cart-item-actions">
            <div class="qty-control">
              <button class="qty-btn" (click)="decrementItem(item)">
                <ion-icon name="remove-outline"></ion-icon>
              </button>
              <span class="qty-count">{{ item.itemCount }}</span>
              <button class="qty-btn" (click)="incrementItem(item)">
                <ion-icon name="add-outline"></ion-icon>
              </button>
            </div>
            <button class="note-btn">Note</button>
            <button class="heart-btn">
              <ion-icon name="heart-outline"></ion-icon>
            </button>
          </div>
        </div>
        <div class="cart-item-right">
          <img [src]="getItemImage(item)" [alt]="item.productName" class="cart-item-img" />
        </div>
      </div>

      <!-- Add More -->
      <div class="add-more-row">
        <span class="add-more-label">Need anything else?</span>
        <button class="add-more-btn" (click)="goToVendor(group.vendorId)">Add more</button>
      </div>

      <!-- Offer area: loading → nudge → applied -->
      <div class="vendor-offer-area">

        <!-- Loading skeleton -->
        <div class="vendor-offer-loading" *ngIf="isLoadingOffers">
          <ion-spinner name="dots" color="medium"></ion-spinner>
          <span>Finding best offers...</span>
        </div>

        <ng-container *ngIf="!isLoadingOffers">

          <!-- NUDGE: offer exists but min-order not yet reached -->
          <ng-container *ngIf="getVendorBestNudgeOffer(group) as nudgeOffer">
            <div class="vendor-offer-nudge">
              <div class="nudge-left">
                <div class="nudge-icon-wrap">
                  <ion-icon name="pricetag-outline"></ion-icon>
                </div>
                <div class="nudge-text">
                  <span class="nudge-headline">
                    Add <strong>&#8377;{{ getVendorNudgeAmount(group) }} more</strong>
                    to unlock <strong class="nudge-discount">{{ getVendorNudgeLabel(nudgeOffer) }}</strong>
                  </span>
                  <span class="nudge-sub">{{ nudgeOffer.title }}</span>
                </div>
              </div>
              <button class="nudge-add-btn" (click)="goToVendor(group.vendorId)">Add items</button>
            </div>
            <!-- Progress bar -->
            <div class="nudge-progress-wrap">
              <div class="nudge-progress-bar"
                   [style.width.%]="(group.subtotal / nudgeOffer.minOrderAmount) * 100 | number:'1.0-0'">
              </div>
            </div>
          </ng-container>

          <!-- AUTO-APPLIED: offer met and applied -->
          <div class="vendor-offer-auto" *ngIf="group.appliedOffer">
            <div class="vendor-offer-auto-left">
              <div class="offer-check-wrap">
                <ion-icon name="checkmark-circle" class="offer-check-icon"></ion-icon>
              </div>
              <div class="vendor-offer-auto-text">
                <span class="vendor-offer-auto-label">
                  <span class="auto-badge">AUTO APPLIED</span>
                </span>
                <span class="vendor-offer-name">
                  {{ group.appliedOffer.code ? group.appliedOffer.code + ' · ' : '' }}{{ group.appliedOffer.title }}
                </span>
                <span class="vendor-offer-auto-savings">
                  <ion-icon name="gift-outline"></ion-icon>
                  You save &#8377;{{ group.offerDiscount }} on this order!
                </span>
              </div>
            </div>
            <button class="vendor-offer-remove-btn" (click)="removeVendorOffer(group)">REMOVE</button>
          </div>

        </ng-container>

        <!-- Subtotal row (always visible) -->
        <div class="vendor-subtotal">
          <span class="subtotal-label">Subtotal</span>
          <div class="vendor-subtotal-prices">
            <span class="subtotal-original" *ngIf="group.offerDiscount">&#8377;{{ group.subtotal.toFixed(2) }}</span>
            <span class="subtotal-amount" [class.amount-savings]="group.offerDiscount">
              &#8377;{{ (group.subtotal - (group.offerDiscount || 0)).toFixed(2) }}
            </span>
          </div>
        </div>

      </div>
    </div>

    <div class="divider"></div>

    <!-- Apply Coupon Section -->
    <div class="coupon-section" *ngIf="!appliedOffer">

      <!-- Collapsed State -->
      <div class="coupon-collapsed" *ngIf="!showOfferSheet" (click)="toggleOfferSheet()">
        <div class="coupon-collapsed-left">
          <ion-icon name="pricetag-outline" class="coupon-icon"></ion-icon>
          <span class="coupon-label">Apply Coupon</span>
        </div>
        <ion-icon name="chevron-down-outline" class="coupon-toggle-icon"></ion-icon>
      </div>

      <!-- Best Offer Suggestion (collapsed) -->
      <div class="best-offer-suggestion" *ngIf="!showOfferSheet && getBestOffer() && !isLoadingOffers" (click)="toggleOfferSheet()">
        <div class="best-offer-info">
          <ion-icon name="gift-outline" class="best-offer-icon"></ion-icon>
          <span class="best-offer-text">
            Best offer: <strong>{{ getBestOffer().code || getBestOffer().title }}</strong> saves
            <strong>&#8377;{{ getOfferSavings(getBestOffer()) }}</strong>
          </span>
        </div>
        <button class="best-offer-apply-btn" (click)="$event.stopPropagation(); applyOffer(getBestOffer())">APPLY</button>
      </div>

      <!-- Loading -->
      <div class="coupon-loading" *ngIf="!showOfferSheet && isLoadingOffers">
        <ion-spinner name="dots" color="medium"></ion-spinner>
        <span>Finding best offers...</span>
      </div>

      <!-- Expanded State -->
      <div class="coupon-expanded" *ngIf="showOfferSheet">
        <div class="coupon-expanded-header" (click)="toggleOfferSheet()">
          <div class="coupon-collapsed-left">
            <ion-icon name="pricetag-outline" class="coupon-icon"></ion-icon>
            <span class="coupon-label">Apply Coupon</span>
          </div>
          <ion-icon name="chevron-up-outline" class="coupon-toggle-icon"></ion-icon>
        </div>

        <!-- Manual Code Input -->
        <div class="coupon-input-row">
          <input
            type="text"
            class="coupon-input"
            placeholder="Enter coupon code"
            [(ngModel)]="couponCode"
            (keyup.enter)="applyCouponCode()"
          />
          <button class="coupon-apply-btn" (click)="applyCouponCode()" [disabled]="!couponCode.trim()">
            APPLY
          </button>
        </div>

        <!-- Available Offers -->
        <div class="offers-list" *ngIf="applicableOffers.length > 0">
          <h4 class="offers-list-title">Available Offers ({{ applicableOffers.length }})</h4>

          <div class="offer-card-apply" *ngFor="let offer of applicableOffers">
            <div class="offer-card-left">
              <div class="offer-card-header">
                <ion-icon [name]="offer.icon || 'pricetag-outline'" class="offer-card-icon"></ion-icon>
                <span class="offer-card-title">{{ offer.title }}</span>
                <span class="offer-card-badge">{{ getOfferLabel(offer) }}</span>
              </div>
              <p class="offer-card-desc" *ngIf="offer.description">{{ offer.description }}</p>
              <div class="offer-card-meta">
                <span *ngIf="offer.code" class="offer-code-tag">{{ offer.code }}</span>
                <span *ngIf="offer.minOrderAmount > 0" class="offer-min">Min &#8377;{{ offer.minOrderAmount }}</span>
                <span class="offer-saves">Saves &#8377;{{ getOfferSavings(offer) }}</span>
                <span *ngIf="offer.vendor?.name" class="offer-vendor-badge">{{ offer.vendor.name }}</span>
              </div>
            </div>
            <button class="offer-apply-btn" (click)="applyOffer(offer)">APPLY</button>
          </div>
        </div>

        <!-- No Offers -->
        <div class="no-offers" *ngIf="applicableOffers.length === 0 && !isLoadingOffers">
          <p>No applicable offers for this order</p>
          <button class="no-offers-link" (click)="goToDeals()">Browse all deals</button>
        </div>

        <!-- Loading inside expanded -->
        <div class="offers-loading" *ngIf="isLoadingOffers">
          <ion-spinner name="dots" color="medium"></ion-spinner>
          <span>Loading offers...</span>
        </div>
      </div>
    </div>

    <!-- Applied Offer State -->
    <div class="coupon-applied" *ngIf="appliedOffer">
      <ion-icon name="checkmark-circle" class="applied-icon"></ion-icon>
      <div class="applied-info">
        <span class="applied-code">{{ appliedOffer.code || appliedOffer.title }}</span>
        <span class="applied-savings">applied &mdash; you save &#8377;{{ couponDiscount }}</span>
      </div>
      <button class="applied-remove-btn" (click)="removeOffer()">REMOVE</button>
    </div>

    <!-- Payment Summary -->
    <div class="section-block">
      <h3 class="section-heading">Payment summary</h3>

      <div class="summary-row">
        <span>Price</span>
        <div class="summary-prices">
          <span class="original-price" *ngIf="totalOriginalPrice > totalDiscountedPrice">&#8377; {{ totalOriginalPrice.toFixed(2) }}</span>
          <span>&#8377; {{ totalDiscountedPrice.toFixed(2) }}</span>
        </div>
      </div>
      <div class="summary-row vendor-savings-row" *ngIf="vendorDiscountTotal > 0">
        <div class="vendor-savings-label">
          <ion-icon name="storefront-outline" class="vendor-savings-icon"></ion-icon>
          <span>Restaurant offers</span>
        </div>
        <span class="coupon-discount-amount">-&#8377;{{ vendorDiscountTotal.toFixed(2) }}</span>
      </div>
      <div class="summary-row coupon-savings-row" *ngIf="appliedOffer">
        <span>Coupon ({{ appliedOffer.code || appliedOffer.title }})</span>
        <span class="coupon-discount-amount">-&#8377;{{ couponDiscount.toFixed(2) }}</span>
      </div>

      <!-- Delivery Fee -->
      <div class="summary-row">
        <span>Delivery fee<span class="delivery-km" *ngIf="feeBreakdown"> ({{ feeBreakdown.delivery.maxDistanceKm }} km)</span></span>
        <div class="summary-prices" *ngIf="!isLoadingFees && feeBreakdown">
          <ng-container *ngIf="feeBreakdown.delivery.freeDeliveryApplied">
            <span class="original-price">&#8377; {{ feeBreakdown.delivery.originalFee.toFixed(2) }}</span>
            <span class="free-badge-inline">FREE</span>
          </ng-container>
          <span *ngIf="!feeBreakdown.delivery.freeDeliveryApplied">&#8377; {{ feeBreakdown.delivery.fee.toFixed(2) }}</span>
        </div>
        <span class="inline-spinner" *ngIf="isLoadingFees">
          <ion-spinner name="dots" color="medium"></ion-spinner>
        </span>
        <span *ngIf="!isLoadingFees && !feeBreakdown">--</span>
      </div>

      <!-- Platform Fee -->
      <div class="summary-row" *ngIf="feeBreakdown && platformFee > 0">
        <span>Platform fee</span>
        <span>&#8377; {{ platformFee.toFixed(2) }}</span>
      </div>

      <!-- Tax -->
      <div class="summary-row" *ngIf="feeBreakdown && taxAmount > 0">
        <span>
          {{ feeBreakdown.tax.label }}
          <span class="tax-rate" *ngIf="feeBreakdown.tax.type === 'percentage'">({{ feeBreakdown.tax.value }}%)</span>
        </span>
        <span>&#8377; {{ taxAmount.toFixed(2) }}</span>
      </div>

      <div class="summary-row total-row">
        <span>Total payment</span>
        <span class="total-amount">&#8377; {{ totalPayment.toFixed(2) }}</span>
      </div>

      <!-- View Details Toggle -->
      <button class="view-details-link" (click)="toggleFeeDetails()" *ngIf="feeBreakdown">
        <span>{{ showFeeDetails ? 'Hide details' : 'View details' }}</span>
        <ion-icon [name]="showFeeDetails ? 'chevron-up-outline' : 'chevron-down-outline'"></ion-icon>
      </button>

      <!-- Expandable Fee Details -->
      <div class="fee-details-expand" *ngIf="showFeeDetails && feeBreakdown">
        <!-- Delivery Breakdown -->
        <div class="fee-details-section">
          <div class="fee-details-title">Delivery breakdown</div>
          <div class="fee-detail-row" *ngFor="let vd of feeBreakdown.delivery.vendorDistances">
            <span>{{ vd.vendorName }}</span>
            <span class="fee-detail-value">{{ vd.distanceKm }} km</span>
          </div>
          <div class="fee-detail-row">
            <span>Base fee (first {{ feeBreakdown.delivery.baseDistanceKm }} km)</span>
            <span class="fee-detail-value">&#8377; {{ feeBreakdown.delivery.baseFee }}</span>
          </div>
          <div class="fee-detail-row" *ngIf="feeBreakdown.delivery.maxDistanceKm > feeBreakdown.delivery.baseDistanceKm">
            <span>Extra distance ({{ (feeBreakdown.delivery.maxDistanceKm - feeBreakdown.delivery.baseDistanceKm).toFixed(1) }} km x &#8377;{{ feeBreakdown.delivery.perKmCharge }})</span>
            <span class="fee-detail-value">&#8377; {{ ((feeBreakdown.delivery.maxDistanceKm - feeBreakdown.delivery.baseDistanceKm) * feeBreakdown.delivery.perKmCharge).toFixed(2) }}</span>
          </div>
          <div class="fee-detail-row fee-detail-note" *ngIf="feeBreakdown.delivery.storeCount > 1">
            <span>Multi-store surcharge ({{ feeBreakdown.delivery.storeCount }} stores, +{{ (feeBreakdown.delivery.storeCount - 1) * feeBreakdown.delivery.multiStoreSurchargePercent }}%)</span>
          </div>
          <div class="fee-detail-row fee-detail-note" *ngIf="feeBreakdown.delivery.freeDeliveryApplied">
            <ion-icon name="checkmark-circle" class="free-check-icon"></ion-icon>
            <span>Free delivery applied (order above &#8377;{{ feeBreakdown.delivery.freeDeliveryThreshold }})</span>
          </div>
          <div class="fee-detail-row fee-detail-note" *ngIf="!feeBreakdown.delivery.freeDeliveryApplied && feeBreakdown.delivery.freeDeliveryThreshold > 0">
            <ion-icon name="information-circle-outline" class="info-icon"></ion-icon>
            <span>Add &#8377;{{ (feeBreakdown.delivery.freeDeliveryThreshold - totalDiscountedPrice).toFixed(0) }} more for free delivery</span>
          </div>
        </div>

        <!-- Platform Fee Details -->
        <div class="fee-details-section" *ngIf="platformFee > 0">
          <div class="fee-details-title">Platform fee</div>
          <div class="fee-detail-row">
            <span>Service & operations charge</span>
            <span class="fee-detail-value">&#8377; {{ platformFee.toFixed(2) }}</span>
          </div>
        </div>

        <!-- Tax Details -->
        <div class="fee-details-section" *ngIf="taxAmount > 0">
          <div class="fee-details-title">{{ feeBreakdown.tax.label }}</div>
          <div class="fee-detail-row">
            <span *ngIf="feeBreakdown.tax.type === 'percentage'">{{ feeBreakdown.tax.value }}% on item total</span>
            <span *ngIf="feeBreakdown.tax.type === 'flat'">Flat tax</span>
            <span class="fee-detail-value">&#8377; {{ taxAmount.toFixed(2) }}</span>
          </div>
        </div>
      </div>
    </div>

    <!-- Payment Method -->
    <div class="payment-method">
      <ion-icon name="wallet-outline" class="wallet-icon"></ion-icon>
      <span class="wallet-label">My wallet</span>
      <ion-icon name="chevron-down-outline" class="wallet-arrow"></ion-icon>
      <span class="wallet-dot">&middot;</span>
      <span class="wallet-amount">&#8377; {{ totalPayment.toFixed(2) }}</span>
    </div>

    <!-- Savings -->
    <p class="savings-text" *ngIf="totalSaved > 0">You saved &#8377; {{ totalSaved.toFixed(2) }}<span *ngIf="appliedOffer"> with {{ appliedOffer.code || appliedOffer.title }}</span></p>

  </div>

</ion-content>

<!-- Footer: Place Order -->
<ion-footer class="ion-no-border" *ngIf="!isCartEmpty">
  <div class="footer-wrap">
    <button class="place-order-btn" (click)="openPaymentModal()">Place order</button>
  </div>
</ion-footer>
