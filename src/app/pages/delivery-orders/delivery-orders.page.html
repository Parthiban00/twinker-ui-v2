<ion-header>
  <ion-toolbar>
    <ion-buttons slot="start">
      <ion-back-button defaultHref="/tabs/profile" text=""></ion-back-button>
    </ion-buttons>
    <ion-title>My Deliveries</ion-title>
    <ion-buttons slot="end">
      <div class="tracking-badge" *ngIf="isTracking">
        <span class="tracking-dot"></span>
        Live
      </div>
    </ion-buttons>
  </ion-toolbar>

  <!-- Status Tabs -->
  <div class="status-tabs">
    <button class="status-tab" [class.active]="activeTab === 'available'" (click)="setTab('available')">
      Available
      <span class="tab-count" *ngIf="tabCounts.available > 0">{{ tabCounts.available }}</span>
    </button>
    <button class="status-tab" [class.active]="activeTab === 'active'" (click)="setTab('active')">
      Active
      <span class="tab-count" *ngIf="tabCounts.active > 0">{{ tabCounts.active }}</span>
    </button>
    <button class="status-tab" [class.active]="activeTab === 'done'" (click)="setTab('done')">
      Done
      <span class="tab-count" *ngIf="tabCounts.done > 0">{{ tabCounts.done }}</span>
    </button>
  </div>
</ion-header>

<ion-content>

  <!-- ═══════════════════════════════════════════════════ -->
  <!-- AVAILABLE TAB                                       -->
  <!-- ═══════════════════════════════════════════════════ -->
  <ng-container *ngIf="activeTab === 'available'">

    <!-- Skeleton -->
    <ng-container *ngIf="isLoadingAvailable">
      <div class="order-card skeleton-card" *ngFor="let i of [1,2,3]">
        <ion-skeleton-text animated style="width: 40%; height: 12px; border-radius: 6px;"></ion-skeleton-text>
        <ion-skeleton-text animated style="width: 70%; height: 18px; margin-top: 10px; border-radius: 6px;"></ion-skeleton-text>
        <ion-skeleton-text animated style="width: 55%; height: 12px; margin-top: 8px; border-radius: 6px;"></ion-skeleton-text>
        <ion-skeleton-text animated style="width: 100%; height: 44px; margin-top: 14px; border-radius: 10px;"></ion-skeleton-text>
      </div>
    </ng-container>

    <!-- No locality assigned -->
    <div class="no-locality-state" *ngIf="!isLoadingAvailable && noLocalityAssigned">
      <div class="no-locality-icon">
        <ion-icon name="location-outline"></ion-icon>
      </div>
      <p class="no-locality-title">No locality assigned</p>
      <span class="no-locality-sub">Contact your admin to assign a delivery area to your account.</span>
    </div>

    <!-- Empty -->
    <div class="empty-state" *ngIf="!isLoadingAvailable && !noLocalityAssigned && availableOrders.length === 0">
      <div class="empty-icon-wrap">
        <ion-icon name="bicycle-outline"></ion-icon>
      </div>
      <p>No orders available</p>
      <span>New orders will appear here when vendors mark them ready</span>
    </div>

    <!-- Cards -->
    <div class="order-card available-card"
      *ngFor="let order of availableOrders"
      [class.urgent-card]="isUrgent(order)">

      <!-- Top row -->
      <div class="card-top-row">
        <div class="time-ago" [class.urgent]="isUrgent(order)">
          <ion-icon name="time-outline"></ion-icon>
          {{ getTimeSince(order.createdAt) }}
        </div>
        <div class="payment-badge" [class.online]="order.paymentMethod === 'online'">
          {{ order.paymentMethod === 'online' ? 'ONLINE' : 'COD' }}
        </div>
      </div>

      <!-- Vendor info -->
      <div class="avail-vendor-row">
        <div class="avail-vendor-icon">
          <ion-icon [name]="getVerticalIcon(order)"></ion-icon>
        </div>
        <div class="avail-vendor-info">
          <div class="avail-vendor-name">{{ getVendorNames(order) }}</div>
          <div class="avail-items-meta">{{ getItemCount(order) }} item{{ getItemCount(order) !== 1 ? 's' : '' }}</div>
        </div>
        <div class="avail-amount">₹{{ order.totalAmount | number:'1.0-0' }}</div>
      </div>

      <!-- Destination hint -->
      <div class="dest-row">
        <ion-icon name="navigate-outline" class="dest-icon"></ion-icon>
        <span class="dest-text">Deliver to: {{ getCustomerArea(order) || 'Customer location' }}</span>
      </div>

      <div class="card-divider"></div>

      <!-- Accept button -->
      <button class="btn-accept" (click)="acceptOrder(order)">
        <ion-icon name="checkmark-circle-outline"></ion-icon>
        Accept Order
      </button>
    </div>
  </ng-container>

  <!-- ═══════════════════════════════════════════════════ -->
  <!-- ACTIVE TAB                                          -->
  <!-- ═══════════════════════════════════════════════════ -->
  <ng-container *ngIf="activeTab === 'active'">

    <!-- Skeleton -->
    <ng-container *ngIf="isLoadingActive">
      <div class="order-card skeleton-card" *ngFor="let i of [1,2]">
        <ion-skeleton-text animated style="width: 50%; height: 12px; border-radius: 6px;"></ion-skeleton-text>
        <ion-skeleton-text animated style="width: 75%; height: 18px; margin-top: 10px; border-radius: 6px;"></ion-skeleton-text>
        <ion-skeleton-text animated style="width: 90%; height: 38px; margin-top: 14px; border-radius: 10px;"></ion-skeleton-text>
      </div>
    </ng-container>

    <!-- Empty -->
    <div class="empty-state" *ngIf="!isLoadingActive && activeOrders.length === 0">
      <div class="empty-icon-wrap">
        <ion-icon name="bag-check-outline"></ion-icon>
      </div>
      <p>No active deliveries</p>
      <span>Accept an order from the Available tab</span>
    </div>

    <!-- Cards -->
    <ng-container *ngFor="let order of activeOrders">
      <ng-container [ngSwitch]="getActiveOrderState(order)">

        <!-- State: Waiting for vendor -->
        <div class="order-card waiting-card" *ngSwitchCase="'waiting'">
          <div class="card-top-row">
            <div class="status-label-row">
              <span class="waiting-dot"></span>
              <span class="status-text waiting-text">Vendor preparing…</span>
            </div>
            <div class="payment-badge" [class.online]="order.paymentMethod === 'online'">
              {{ order.paymentMethod === 'online' ? 'ONLINE' : 'COD' }}
            </div>
          </div>

          <div class="active-customer-row">
            <div class="active-customer-name">{{ getCustomerName(order) }}</div>
            <div class="active-order-id">{{ order.orderId }}</div>
          </div>

          <div class="active-vendor-strip">
            <ion-icon name="storefront-outline"></ion-icon>
            <span>{{ getVendorNames(order) }}</span>
          </div>

          <div class="card-divider"></div>

          <div class="waiting-info-row">
            <ion-icon name="hourglass-outline"></ion-icon>
            <span>Order is being prepared by the vendor. We'll let you know when it's ready for pickup.</span>
          </div>
        </div>

        <!-- State: Go pick up (all vendors ready) -->
        <div class="order-card pickup-card" *ngSwitchCase="'go_pickup'">
          <div class="card-top-row">
            <div class="status-label-row">
              <span class="ready-dot"></span>
              <span class="status-text ready-text">Ready for Pickup</span>
            </div>
            <div class="time-ago">
              <ion-icon name="time-outline"></ion-icon>
              {{ getTimeSince(order.createdAt) }}
            </div>
          </div>

          <div class="active-customer-row">
            <div class="active-customer-name">{{ getCustomerName(order) }}</div>
            <div class="active-order-id">{{ order.orderId }}</div>
          </div>

          <div class="active-vendor-strip">
            <ion-icon name="storefront-outline"></ion-icon>
            <span>{{ getVendorNames(order) }}</span>
          </div>

          <div class="active-amount-row">
            <span class="active-amount-label">Order Total</span>
            <span class="active-amount">₹{{ order.totalAmount | number:'1.0-0' }}</span>
          </div>

          <div class="card-divider"></div>

          <div class="action-row">
            <button class="btn-navigate btn-vendor" (click)="navigateToVendor(order)">
              <ion-icon name="navigate-outline"></ion-icon>
              Go to Vendor
            </button>
            <button class="btn-pickup-action" (click)="markPickedUp(order)">
              <ion-icon name="bag-check-outline"></ion-icon>
              Mark Picked Up
            </button>
          </div>
        </div>

        <!-- State: Out for delivery -->
        <div class="order-card delivery-card" *ngSwitchCase="'out_for_delivery'">
          <div class="card-top-row">
            <div class="status-label-row">
              <span class="delivery-dot"></span>
              <span class="status-text delivery-text">Out for Delivery</span>
            </div>
            <div class="payment-badge" [class.online]="order.paymentMethod === 'online'">
              {{ order.paymentMethod === 'online' ? 'ONLINE' : 'COD' }}
            </div>
          </div>

          <div class="active-customer-row">
            <div class="active-customer-name">{{ getCustomerName(order) }}</div>
            <div class="active-order-id">{{ order.orderId }}</div>
          </div>

          <!-- Delivery address -->
          <div class="delivery-address-strip">
            <ion-icon name="location-outline"></ion-icon>
            <span>{{ getDeliveryAddress(order) }}</span>
          </div>

          <div class="active-amount-row">
            <span class="active-amount-label">
              <span *ngIf="order.paymentMethod === 'cod'" class="cod-collect">Collect ₹{{ order.totalAmount | number:'1.0-0' }} on delivery</span>
              <span *ngIf="order.paymentMethod !== 'cod'" class="online-paid">Paid online · ₹{{ order.totalAmount | number:'1.0-0' }}</span>
            </span>
            <button class="call-btn" (click)="callCustomer(order)">
              <ion-icon name="call-outline"></ion-icon>
            </button>
          </div>

          <div class="card-divider"></div>

          <div class="action-row">
            <button class="btn-navigate btn-customer" (click)="navigateToCustomer(order)">
              <ion-icon name="navigate-outline"></ion-icon>
              Navigate
            </button>
            <button class="btn-delivered" (click)="openDeliveredModal(order)">
              <ion-icon name="checkmark-done-outline"></ion-icon>
              Mark Delivered
            </button>
          </div>
        </div>

      </ng-container>
    </ng-container>
  </ng-container>

  <!-- ═══════════════════════════════════════════════════ -->
  <!-- DONE TAB                                            -->
  <!-- ═══════════════════════════════════════════════════ -->
  <ng-container *ngIf="activeTab === 'done'">

    <!-- Skeleton -->
    <ng-container *ngIf="isLoadingDone">
      <div class="order-card skeleton-card" *ngFor="let i of [1,2,3]">
        <ion-skeleton-text animated style="width: 45%; height: 12px; border-radius: 6px;"></ion-skeleton-text>
        <ion-skeleton-text animated style="width: 65%; height: 17px; margin-top: 10px; border-radius: 6px;"></ion-skeleton-text>
        <ion-skeleton-text animated style="width: 50%; height: 12px; margin-top: 8px; border-radius: 6px;"></ion-skeleton-text>
      </div>
    </ng-container>

    <!-- Empty -->
    <div class="empty-state" *ngIf="!isLoadingDone && doneOrders.length === 0">
      <div class="empty-icon-wrap">
        <ion-icon name="checkmark-done-circle-outline"></ion-icon>
      </div>
      <p>No deliveries yet</p>
      <span>Your completed deliveries will show here</span>
    </div>

    <!-- Cards -->
    <div class="order-card done-card" *ngFor="let order of doneOrders">
      <div class="card-top-row">
        <div class="done-status-row">
          <ion-icon name="checkmark-circle" class="done-icon"></ion-icon>
          <span class="done-label">Delivered</span>
        </div>
        <div class="done-time">{{ getTimeSince(order.updatedAt || order.createdAt) }}</div>
      </div>

      <div class="active-customer-row">
        <div class="active-customer-name">{{ getCustomerName(order) }}</div>
        <div class="active-order-id">{{ order.orderId }}</div>
      </div>

      <div class="active-vendor-strip">
        <ion-icon [name]="getVerticalIcon(order)"></ion-icon>
        <span>{{ getVendorNames(order) }}</span>
      </div>

      <div class="done-footer-row">
        <span class="done-items">{{ getItemCount(order) }} item{{ getItemCount(order) !== 1 ? 's' : '' }}</span>
        <span class="done-amount">₹{{ order.totalAmount | number:'1.0-0' }}</span>
      </div>
    </div>
  </ng-container>

  <div style="height: 28px;"></div>
</ion-content>

<!-- ═══════════════════════════════════════════════════ -->
<!-- MARK DELIVERED CONFIRMATION MODAL                   -->
<!-- ═══════════════════════════════════════════════════ -->
<div class="modal-backdrop" *ngIf="showDeliveredModal" (click)="closeDeliveredModal()"></div>
<div class="delivered-modal" *ngIf="showDeliveredModal">
  <div class="delivered-modal-icon">
    <ion-icon name="checkmark-done-circle-outline"></ion-icon>
  </div>
  <div class="delivered-modal-title">Confirm Delivery?</div>
  <div class="delivered-modal-subtitle">
    {{ pendingDeliverOrder?.orderId }}
  </div>
  <div class="delivered-modal-customer" *ngIf="pendingDeliverOrder">
    <ion-icon name="person-outline"></ion-icon>
    {{ getCustomerName(pendingDeliverOrder) }}
  </div>
  <div class="delivered-modal-amount" *ngIf="pendingDeliverOrder?.paymentMethod === 'cod'">
    <ion-icon name="cash-outline"></ion-icon>
    Collect ₹{{ pendingDeliverOrder?.totalAmount | number:'1.0-0' }} from customer
  </div>
  <div class="delivered-modal-actions">
    <button class="modal-cancel-btn" (click)="closeDeliveredModal()">Cancel</button>
    <button class="modal-confirm-btn" (click)="confirmDelivered()">
      <ion-icon name="checkmark-outline"></ion-icon>
      Delivered ✓
    </button>
  </div>
</div>
